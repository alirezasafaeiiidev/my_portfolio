# API Documentation

This document describes the current API behavior implemented in `src/app/api/**`.

## Table of Contents
- [Authentication](#authentication)
- [Public Endpoints](#public-endpoints)
- [Admin Endpoints](#admin-endpoints)
- [Rate Limiting](#rate-limiting)
- [Security Notes](#security-notes)
- [Environment Variables](#environment-variables)

## Authentication

Admin endpoints support two methods:

1. Bearer token
- Header: `Authorization: Bearer <ADMIN_API_TOKEN>`

2. Session cookie
- Login endpoint sets `asdev_admin_session` (`httpOnly`, `sameSite=strict`, `secure` in production)

If admin auth is not configured (`ADMIN_API_TOKEN` or session credentials), protected admin routes return `503`.

## Public Endpoints

### GET `/api`

Health/status endpoint.

Response example:
```json
{
  "status": "ok",
  "service": "portfolio-api",
  "environment": "production",
  "timestamp": "2026-02-13T00:00:00.000Z",
  "uptimeSeconds": 1234
}
```

### POST `/api/contact`

Accepts contact form payload.

Request body:
```ts
{
  name: string          // 2..100
  email: string         // valid email, <=255
  subject?: string      // <=200 (default: "")
  message: string       // 10..5000
}
```

Success response:
```json
{
  "success": true,
  "message": "Message sent successfully"
}
```

Error responses:
- `400` validation/security rejection
- `429` rate limit exceeded
- `500` unexpected server error

Important behavior:
- Current implementation validates/sanitizes input and logs accepted submissions.
- Current implementation does **not** persist contact messages to database.

### GET `/api/contact`

Method guard endpoint.

Response:
- `405` with message: `This endpoint only accepts POST requests`

### GET `/api/messages` (legacy)

Returns all `ContactMessage` rows.

### DELETE `/api/messages?id=<id>` (legacy)

Deletes one `ContactMessage` row by id.

Warning:
- These legacy endpoints are currently public (no admin auth check).
- Keep disabled behind network controls or remove in production.

### GET `/api/rss?lang=en|fa`

Returns RSS XML.

Notes:
- Feed currently uses in-code mock posts (not DB-backed).
- `lang` defaults to `en`.

### GET `/api/og-image`

Returns Open Graph image generated by `next/og`.

### GET `/api/metrics`

Returns Prometheus-compatible metrics.

Sample metrics:
```text
portfolio_api_requests_total
portfolio_api_success_total
portfolio_api_errors_total
portfolio_api_responses_by_status_total{status="200"}
portfolio_process_uptime_seconds
```

## Admin Endpoints

### Auth

#### POST `/api/admin/auth/login`

Request body:
```json
{ "username": "...", "password": "..." }
```

Response:
- `200` `{ "success": true, "role": "admin" }` + session cookie
- `401` invalid credentials
- `503` when session auth env vars are missing

#### POST `/api/admin/auth/logout`

Response:
- `200` `{ "success": true }` and clears session cookie

#### GET `/api/admin/auth/session`

Response:
- `200` `{ "authenticated": true, "role": "admin", "via": "session|bearer" }`
- `401` unauthenticated
- `503` auth not configured

### Messages

#### GET `/api/admin/messages`

Returns all contact messages (admin-only).

#### DELETE `/api/admin/messages?id=<id>`

Deletes one contact message (admin-only).

### Projects

#### GET `/api/admin/projects`

Returns all projects ordered by `order ASC`.

#### POST `/api/admin/projects`

Request body:
```ts
{
  title: string
  description: string
  longDescription?: string
  githubUrl?: string
  liveUrl?: string
  tags: string[] | string
  featured?: boolean
  order?: number
}
```

Response:
- `201` `{ project: ... }`
- `400` validation failure
- `401` unauthorized
- `503` auth not configured

## Rate Limiting

Rate limiting is applied by endpoint key prefix + client IP:
- identifier format: `<prefix>:<client-ip>`
- IP source order: `x-forwarded-for` first, then `x-real-ip`, else `unknown`

Default values:
- `API_RATE_LIMIT_WINDOW_MS=900000` (15 minutes)
- `API_RATE_LIMIT_MAX_REQUESTS=5`

Storage behavior:
- Redis REST (when `REDIS_REST_URL` + `REDIS_REST_TOKEN` are set)
- In-memory fallback otherwise

Response headers:
```http
X-RateLimit-Limit: 5
X-RateLimit-Remaining: 4
X-RateLimit-Reset: 2026-02-13T12:15:00.000Z
X-RateLimit-Policy: fixed_window;w=900;r=5
X-RateLimit-Store: redis|memory
```

## Security Notes

Implemented:
- Input validation with Zod in route handlers
- Input sanitization (`trim`, remove `<` and `>`)
- Suspicious content checks (`hasSqlInjection`, `isLikelySpam` heuristics)
- Timing-safe credential comparison
- Security headers on API responses:
  - `X-Request-ID`
  - `X-Content-Type-Options: nosniff`
  - `Referrer-Policy: no-referrer`
  - `Cache-Control: no-store`

Global headers from `next.config.ts` include:
- `X-DNS-Prefetch-Control: on`
- `X-Frame-Options: SAMEORIGIN`
- `X-Content-Type-Options: nosniff`
- `Referrer-Policy: origin-when-cross-origin`

Known gaps:
- Legacy public `/api/messages` endpoints are unauthenticated.
- No CSRF token mechanism is implemented for admin actions.

## Environment Variables

Required/optional vars used by API behavior:

```env
NODE_ENV=production
DATABASE_URL=file:./db/custom.db

# Admin auth
ADMIN_API_TOKEN=replace-with-strong-token-min-16
ADMIN_USERNAME=admin
ADMIN_PASSWORD=replace-with-strong-password-min-8
ADMIN_SESSION_SECRET=replace-with-strong-secret-min-32
ADMIN_SESSION_MAX_AGE_SECONDS=28800

# Rate limit
API_RATE_LIMIT_WINDOW_MS=900000
API_RATE_LIMIT_MAX_REQUESTS=5
REDIS_REST_URL=https://<redis-host>
REDIS_REST_TOKEN=<redis-token>
```

---

Last updated: 2026-02-13
