<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>داشبورد اجرای نقشه‌راه</title>
  <style>
    :root {
      --bg: #f6f8fb;
      --card: #ffffff;
      --text: #132033;
      --muted: #4f627a;
      --primary: #0f6b8f;
      --border: #d9e3ee;
      --done: #1f8f4d;
      --pending: #8a6d1f;
      --blocked: #b03030;
      --skipped: #5c4a7a;
    }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: Tahoma, "IRANSans", sans-serif; background: linear-gradient(180deg, #f6f8fb 0%, #edf2f8 100%); color: var(--text); }
    .wrap { max-width: 1200px; margin: 0 auto; padding: 20px; }
    .top { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; margin-bottom: 16px; }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 14px; }
    .kpi { font-size: 26px; font-weight: 700; }
    .muted { color: var(--muted); font-size: 13px; }
    .controls { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 10px; margin: 12px 0; }
    select { width: 100%; padding: 8px; border-radius: 8px; border: 1px solid var(--border); background: #fff; }
    .phases { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 12px; margin: 14px 0; }
    .phase-title { font-weight: 700; margin-bottom: 8px; }
    .badge { display: inline-block; border-radius: 999px; padding: 2px 8px; font-size: 12px; }
    .done { background: #e5f6ec; color: var(--done); }
    .pending { background: #fff4d9; color: var(--pending); }
    .blocked { background: #ffe4e4; color: var(--blocked); }
    .skipped { background: #efe7ff; color: var(--skipped); }
    table { width: 100%; border-collapse: collapse; background: #fff; border: 1px solid var(--border); border-radius: 10px; overflow: hidden; }
    th, td { padding: 8px; border-bottom: 1px solid var(--border); font-size: 13px; text-align: right; vertical-align: top; }
    th { background: #f2f7fc; }
    .bars { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin: 14px 0; }
    .bar { background: #fff; border: 1px solid var(--border); border-radius: 10px; padding: 10px; }
    .bar-track { height: 10px; background: #eef3f8; border-radius: 8px; overflow: hidden; }
    .bar-fill { height: 100%; background: var(--primary); }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>داشبورد آفلاین نقشه‌راه</h1>
    <div class="top" id="kpis"></div>

    <div class="controls">
      <div><label>فیلتر فاز</label><select id="phaseFilter"><option value="all">همه</option></select></div>
      <div><label>فیلتر وضعیت</label><select id="statusFilter"><option value="all">همه</option><option value="done">done</option><option value="blocked">blocked</option><option value="pending">pending</option><option value="skipped">skipped</option></select></div>
      <div><label>فیلتر ریسک</label><select id="riskFilter"><option value="all">همه</option><option value="high">high</option><option value="medium">medium</option><option value="low">low</option></select></div>
      <div><label>فیلتر نقش</label><select id="roleFilter"><option value="all">همه</option></select></div>
    </div>

    <div class="bars" id="riskBars"></div>
    <div class="phases" id="phases"></div>

    <h2>برد تسک‌ها</h2>
    <table>
      <thead>
        <tr>
          <th>فاز</th><th>کد</th><th>عنوان</th><th>وضعیت</th><th>ریسک</th><th>نقش‌ها</th><th>هدف</th>
        </tr>
      </thead>
      <tbody id="tasksBody"></tbody>
    </table>
  </div>

  <script>
    const statusClass = (s) => (['done','pending','blocked','skipped'].includes(s) ? s : 'pending');

    function uniq(arr) { return [...new Set(arr)]; }

    function render(data) {
      const phases = data.phases || [];
      const allTasks = phases.flatMap(p => (p.tasks || []).map(t => ({...t, phase: p.name, phaseId: p.id})));

      const roleFilter = document.getElementById('roleFilter');
      const phaseFilter = document.getElementById('phaseFilter');
      uniq(allTasks.flatMap(t => t.required_roles || [])).forEach(r => {
        const o = document.createElement('option'); o.value = r; o.textContent = r; roleFilter.appendChild(o);
      });
      phases.forEach(p => {
        const o = document.createElement('option'); o.value = p.id; o.textContent = p.name; phaseFilter.appendChild(o);
      });

      const counts = {
        total: allTasks.length,
        done: allTasks.filter(t => t.status === 'done').length,
        blocked: allTasks.filter(t => t.status === 'blocked').length,
        pending: allTasks.filter(t => t.status === 'pending').length,
        skipped: allTasks.filter(t => t.status === 'skipped').length,
      };

      document.getElementById('kpis').innerHTML = [
        ['کل تسک‌ها', counts.total],
        ['انجام‌شده', counts.done],
        ['Blocked', counts.blocked],
        ['Pending', counts.pending]
      ].map(([t,v]) => `<div class="card"><div class="muted">${t}</div><div class="kpi">${v}</div></div>`).join('');

      const riskCount = {
        high: allTasks.filter(t => t.risk_level === 'high').length,
        medium: allTasks.filter(t => t.risk_level === 'medium').length,
        low: allTasks.filter(t => t.risk_level === 'low').length,
      };
      const maxRisk = Math.max(1, riskCount.high, riskCount.medium, riskCount.low);
      document.getElementById('riskBars').innerHTML = ['high','medium','low'].map(r => `
        <div class="bar">
          <div class="muted">ریسک ${r}</div>
          <div style="font-weight:700">${riskCount[r]}</div>
          <div class="bar-track"><div class="bar-fill" style="width:${(riskCount[r]/maxRisk)*100}%"></div></div>
        </div>
      `).join('');

      document.getElementById('phases').innerHTML = phases.map(p => {
        const done = (p.tasks || []).filter(t => t.status === 'done').length;
        const total = (p.tasks || []).length;
        return `<div class="card"><div class="phase-title">${p.name}</div><div class="muted">${done} / ${total} done</div><div class="badge ${statusClass(p.status)}">${p.status}</div></div>`;
      }).join('');

      function applyFilters() {
        const fp = phaseFilter.value;
        const fs = document.getElementById('statusFilter').value;
        const fr = document.getElementById('riskFilter').value;
        const frole = roleFilter.value;

        const rows = allTasks.filter(t => {
          if (fp !== 'all' && t.phaseId !== fp) return false;
          if (fs !== 'all' && t.status !== fs) return false;
          if (fr !== 'all' && t.risk_level !== fr) return false;
          if (frole !== 'all' && !(t.required_roles || []).includes(frole)) return false;
          return true;
        });

        document.getElementById('tasksBody').innerHTML = rows.map(t => `
          <tr>
            <td>${t.phase}</td>
            <td>${t.id}</td>
            <td>${t.title}</td>
            <td><span class="badge ${statusClass(t.status)}">${t.status}</span></td>
            <td>${t.risk_level}</td>
            <td>${(t.required_roles || []).join('، ')}</td>
            <td>${t.goal || ''}</td>
          </tr>
        `).join('');
      }

      ['phaseFilter','statusFilter','riskFilter','roleFilter'].forEach(id => document.getElementById(id).addEventListener('change', applyFilters));
      applyFilters();
    }

    fetch('./data/roadmap_data.json').then(r => r.json()).then(render).catch((e) => {
      document.body.innerHTML = `<pre style="padding:16px">خطا در بارگذاری داده داشبورد: ${e}</pre>`;
    });
  </script>
</body>
</html>
